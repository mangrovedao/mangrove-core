This package contains the Solidity implementation of Mangrove as well as deployment scripts and example Solidity offer logics.

# Installation

First, clone the repo and install the prerequisites for the monorepo described in the root [README.md](../../README.md).

Next, run the following commands:

```shell
$ yarn install   # Sets up the Mangrove monorepo and install dependencies
$ yarn build     # Compiles Mangrove and offer logics
```

After the initial installation, it is sufficient to run `yarn build` after updating the clone - this will also run `yarn install`.

# Foundry and its use in this package

This package relies heavily on the [Foundry](https://book.getfoundry.sh/) development framework for Ethereum. It includes an [EVM interpreter](https://github.com/gakonst/ethers-rs) with special hooks for

- interpreting `console.log`-type statements
- displaying Solidity stack traces on reverts.

For example, you can use `console.log` in contracts for debugging; those logs survive transaction revert. More in [Foundry's](https://book.getfoundry.sh/reference/forge-std/console-log?highlight=console#console-logging). Example:

```
string memory s = "Hello";
uint n = 31;
console.log("Message %s number %d",s,d);
```

# Tests

To run all tests in the package, just run `yarn test`.

To run specific tests or test suites, see the instructions in the following sectins.

## How to run Solidity tests for Mangrove

This package contains a comprehensive test suite for Mangrove, implemented in Solidity using [foundry](https://book.getfoundry.sh/index.html).

This test suite can be run with:

```bash
$ yarn test:solidity
```

The tests are located in [./contracts/Tests](./contracts/Tests).

Refer to the documentation of [foundry](https://book.getfoundry.sh/index.html) for details on how tests are structured and options for running it.

## How to run offer logic tests

Tests for the example offer logics are implemented in JavaScript and are located here: [./test](./test).

The tests run a on a local fork of either Ethereum or Polygon mainnet. This ensures that the offer logics use the actual mainnet versions of the DeFi bricks they use, e.g. Aave and Compound.

In order to run the tests, you must provide URLs for mainnet endpoints in the following environment variables:

```bash
# URL for an Ethereum endpoint
ETHEREUM_NODE_URL=https://eth-mainnet.alchemyapi.io/v2/<API key>
# URL for a Polygon endpoint
POLYGON_NODE_URL=https://polygon-mainnet.g.alchemy.com/v2/<API key>
```

You can set up free accounts with any endpoint provider, e.g. Infura or Alchemy.

For convencience, you can store the environment variables in `./.env.test.local`. You can use [.env.local.example](.env.local.example) as a template.

The full test suite can be run with:

```bash
# Run offer logic tests against fork of Ethereum mainnet:
$ yarn test:ethereum-mainnet

# Run offer logic tests against fork of Polygon mainnet:
$ yarn test:polygon-mainnet
```

To run specific test suites, use the `testSuites` package script:

```bash
 yarn run testSuites -n/--network <network> [testSuite1 ...]
 # Example running the basic test suite (test-basic.js) on a Polygon mainnet fork:
 yarn run testSuites -n polygon basic
```

# Deploying on Mangrove

Mangrove uses `forge script`

[`forge script <scriptName>`](https://book.getfoundry.sh/reference/forge/forge-script) executes an arbitrary smart contract function locally. Then, any CALLs executed therein and preceded by the cheatcode [`vm.broadcast()`](https://book.getfoundry.sh/cheatcodes/broadcast) can be broadcast to a remote node by reading a forge-generated `run-*.json` field.

## Generating Mangrove address files

The log of transactions generated by `forge script` gets written to `broadcast/<scriptName>/<chainId>/run-latest.json`. It is an array of low-level transactions info with some additions like newly created contract names.

Mangrove needs to:

- Name its contract (multiple instances of the same contract may be deployed)
- Ignore script names (different scripts are used for different networks)
- Have all its deployed contracts in one place

To do the above, Mangrove adds a layer to `forge script` deployment.

- Deployment scripts should inherit the `Deployer` contract.
- You should call `outputDeployment()` at the end of your scripts.
  - When `outputDeployment()` gets called, a file all known deployed contracts are written to `addresses/deployed.backup/<network>-latest.json`
- You should set `WRITE_DEPLOY=true` when running scripts that you want to broadcast.
  - When `WRITE_DEPLOY=true`, the contract set is also written to `addresses/deployed/<network>.json`.

(Note that for mumbai, `network=maticmum`)

## Foundry keywords for rpc and verification

We use foundry's [`[rpc_endpoints]`](https://book.getfoundry.sh/cheatcodes/rpc#examples) and [`[etherscan]`](https://book.getfoundry.sh/reference/config/etherscan?highlight=etherscan#etherscan) config sections. If the same key exists in both, you can drop the `--etherscan-api-key` from the commandline arguments. For instance if `mumbai` is defined in both sections, you can say `forge script --fork-url mumbai ... --verify` and any deployed contracts will get verified through etherscan using the `mumbai` API key of the `[etherscan]` section.

(Note: in this context, etherscan can mean "polygonscan" or any block explorer)

## Chain-dependent broadcast with private keys in .env

The `vm.broadcast()` cheatcode implicitly selects a sender for the broadcast transactions: either the default sender, or the address associated to the `--private-key` given in the CLI, or to `--mnemonic` information, etc.

It is tiring to always add `--private-key 0x..` to scripts, especially since the key may be different for each network. The `Deployer` contract has a `broadcast()` function that reads the `<NAME>_PRIVATE_KEY` var off the environment, where `NAME` is the name of the chain you're talking to.

- You should have vars such as `MUMBAI_PRIVATE_KEY` , `POLYGON_PRIVATE_KEY` in your `.env` file
- You should use `broadcast()` instead of `vm.broadcast()`. The deployer contract will look for the correct private key, and fallback to the CLI-provided key if none was found.

(Note that for Mumbai, `name=”mumbai”`)

# Generate documentation

The Mangrove Solidity files contain documentation that can be extracted to a nicely formatted and navigable HTML file by running `yarn doc` which will generate a `doc/MgvDoc.html`.

# Configuration

This package uses hierarchical configurations via [node-config](https://github.com/lorenwest/node-config). The main configuration is in [./config/default.js](./config/default.js) and the other .js files in the same directory specify environment/stage specific overrides. Please refer to the documentation for node-config for details on how the configuration hierarchy is resolved.

It is possible to override parts of the configuration with environment variables. This is controlled by [./config/custom-environment-variables.json](./config/custom-environment-variables.json). The structure of this file mirrors the configuration structure but with names of environment variables in the places where these can override a part of the configuration.

For more information, please refer to the node-config's documentation of this feature: https://github.com/lorenwest/node-config/wiki/Environment-Variables#custom-environment-variables .
